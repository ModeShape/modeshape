<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ JBoss DNA (http://www.jboss.org/dna)
  ~
  ~ See the COPYRIGHT.txt file distributed with this work for information
  ~ regarding copyright ownership.  Some portions may be licensed
  ~ to Red Hat, Inc. under one or more contributor license agreements.
  ~ See the AUTHORS.txt file in the distribution for a full listing of 
  ~ individual contributors.
  ~
  ~ JBoss DNA is free software. Unless otherwise indicated, all code in JBoss DNA
  ~ is licensed to you under the terms of the GNU Lesser General Public License as
  ~ published by the Free Software Foundation; either version 2.1 of
  ~ the License, or (at your option) any later version.
  ~
  ~ JBoss DNA is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
  ~ or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License
  ~ for more details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public License
  ~ along with this distribution; if not, write to:
  ~ Free Software Foundation, Inc.
  ~ 51 Franklin Street, Fifth Floor
  ~ Boston, MA  02110-1301  USA
  -->
<!DOCTYPE preface PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd"	[
<!ENTITY % CustomDTD SYSTEM "../../custom.dtd">
%CustomDTD;
]>
<chapter id="jcr">
  <title>Using the JCR API with JBoss DNA</title>
  <para>
  	The
    <ulink url="&JSR170;">Content Repository for Java technology API</ulink>
    provides a standard Java API for working with content repositories. Abbreviated "JCR", this API was developed as part of the
    Java Community Process under <ulink url="&JSR170;">JSR-170</ulink> (JCR 1.0) and is being revised under <ulink url="&JSR283;">JSR-283</ulink>.
		JBoss DNA provides a partial JCR 1.0 implementation that allows you to work with the contents of a repository using the
		JCR API.  For information about how to use the JCR API, please see the <ulink url="&JSR170;">JSR-170</ulink> specification.
	<note>
		<para>In the interests of brevity, this chapter does not attempt to reproduce the JSR-170 specification nor provide
		an exhaustive definition of JBoss DNA JCR capabilities.  Rather, this chapter will describe any deviations from the
		specification as well as any DNA-specific public APIs and configuration.
		</para>
	</note>
  </para>
	<para>Using JBoss DNA within your application is actually quite straightforward.  As you'll see in this chapter,
		the first step is setting up JBoss DNA and starting the <code>JcrEngine</code>.  After that, you obtain the
		<code>javax.jcr.Repository</code> instance for a named repository and just use the standard JCR API throughout your
		application.
	</para>
  <sect1>	
    <title>Obtaining JCR Repositories</title>
		<para>Once you've obtained a reference to a <code>JcrEngine</code> as described in 
		<link linkend="configuration">the previous chapter</link>, obtaining a repository is as easy as calling
		the <code>getRepository(String)</code> method with the name of the repository that you just configured.
<programlisting>
&String; repositoryName = ...;
&JcrEngine; jcrEngine = ...;
&Repository; repository = jcrEngine.getRepository(repositoryName);
</programlisting>
			At this point, your application can proceed by working with the JCR API.
		</para>
  </sect1>
  <sect1 id="jcr-sessions">
    <title>Creating JCR Sessions</title>
		<para>Once you have obtained a reference to the JCR &Repository;, you can create a JCR session using one of its
			<code>login(...)</code> methods.  The <ulink url="&JSR170;">JSR-170</ulink> specification provides four login methods, but the
			behavior of these methods depends on the kind of authentication system your application is using.
		</para>
	  <sect2 id="jcr-sessions-jaas">
	    <title>Using JAAS</title>
		<para>The <code>login()</code> method allows the implementation to choose its own security context to create a session in the default workspace
		for the repository.  The JBoss DNA JCR implementation uses the security context from the current JAAS &AccessControlContext;.  This implies
		that this method will throw a &LoginException; if it is not executed as a &PrivilegedAction;.  Here is one example of how this might  
		work:
    <programlisting>
Subject subject = ...;
&Session; session = Subject.doAsPrivileged(subject, new PrivilegedExceptionAction&lt;&Session;&gt;() {
    public Session run() throws Exception {
        return repository.login();
    }
}, AccessController.getContext());
</programlisting>	
		Another variant of this is to use the AccessControlContext directly, which then operates against the current Subject:
    <programlisting>
&Session; session = AccessController.doPrivileged( new PrivilegedExceptionAction&lt;&Session;&gt;() {
    public Session run() throws Exception {
        return repository.login();
    }
});
</programlisting>	
	</para>
	<para>
		Either of these approaches will yield a session with the same user name and roles as <code>subject</code>.  The <code>login(String workspaceName)</code>
		method is comparable and allows the workspace to be specified by name:
    <programlisting>
Subject subject = ...;
final &String; workspaceName = ...;
&Session; session = (&Session;) Subject.doAsPrivileged(subject, new PrivilegedExceptionAction&lt;&Session;&gt;() {
    public Session run() throws Exception {
        return repository.login(workspaceName);
    }}, AccessController.getContext());
</programlisting>	
		</para>
		<para>The JCR API also allows supplying a JCR &Credentials; object directly as part of the login process, although JBoss DNA imposes
		some requirements on what types of &Credentials; may be supplied.  The simplest way is to provide a JCR &SimpleCredentials; object.
		These credentials will be validated against the JAAS realm named "dna-jcr", unless another realm name is provided as an option 
		during the JCR repository configuration.  For example:
	    <programlisting>
&String; userName = ...;
char[] password = ...;
&Session; session = repository.login(new &SimpleCredentials;(userName, password));
</programlisting>	
		Similarly, the <code>login(Credentials credentials, String workspaceName)</code> method enables passing the credentials and a workspace name:
	    <programlisting>
&String; userName = ...;
char[] password = ...;
&String; workspaceName = ...;
&Session; session = repository.login(new &SimpleCredentials;(userName, password), workspaceName);
</programlisting>	
		If a &LoginContext; is available for the user, that can be used as part of the credentials to authenticate the user with
		JBoss DNA instead.  This snippet uses an anonymous class to provide the login context, but any class with a <code>&LoginContext; getLoginContext()</code>
		method can be used as well.
	    <programlisting>
final &LoginContext; loginContext = ...;
&Session; session = repository.login(new &Credentials;() {
	&LoginContext; loginContext getLoginContext() {
		return loginContext;
	}
}, workspaceName);
</programlisting>
      </para>
	  </sect2>
		<sect2 id="jcr-sessions-custom">
  		<title>Using Custom security</title>
			<para>
		Not all applications can or want to use JAAS for their authentication system, so JBoss DNA provides a way to integrate your own custom
		security provider.  The first step is to provide a custom implementation of &SecurityContext; that integrates with your application security, allowing
		JBoss DNA to discover the authenticated user's name, determine whether the authenticated user has been assigned particular roles
		(see the <ulink linkend="dna_jcr_security">JCR Security section</ulink>), and to notify your application security system that the
		authenticated session (for JCR) has ended.
		</para>
		<para>
			The next step is to wrap your &SecurityContext; instance within an instance of &SecurityContextCredentials;, and pass it as the Credentials
			parameter in one of the two <code>login(...)</code> methods:
			<programlisting>
&SecurityContext; securityContext = new CustomSecurityContext(...);
&Session; session = repository.login(new &SecurityContextCredentials;(securityContext));
			</programlisting>			
      Once the &Session; is obtained, the repository content can be accessed and modified like any other JCR repository.
		</para>
		<para>
		  At this time, no roles are required to connect to any workspace, but restrictions on workspace connections will likely be added to JBoss DNA in the near future.  
		  Please see the <ulink linkend="dna_jcr_security">JCR Security section</ulink> for more details on how access is controlled.
		</para>
	</sect2>
		<sect2 id="jcr-sessions-servlet">
  		<title>Using HTTP Servlet security</title>
			<para>
		Servlet-based applications can make use of the servlet's existing authentication mechanism from &HttpServletRequest;.  Please note that 
		the example below assumes that the servlet has a security constraint that prevents unauthenticated access.
	    <programlisting>
&HttpServletRequest; request = ...;
&SecurityContext; securityContext = new &ServletSecurityContext;(request);
&Session; session = repository.login(new &SecurityContextCredentials;(securityContext));
</programlisting>
    You'll note that this is just a specialization of the <ulink linkend="jcr-sessions-custom">custom security context</ulink> approach, since
    the &ServletSecurityContext; just implements the &SecurityContext; interface and delegates to the &HttpServletRequest;.  Feel free to use
    this class in your servlet-based applications.
		</para>
	</sect2>
	</sect1>
	<sect1>
		<title>JCR Specification Support</title>
		<para>
		The JBoss DNA JCR implementation will not be JCR-compliant prior to the 1.0 release.  Additionally, the JCR 
		specification allows some latitude to implementors for some implementation details.  The sections below
		clarify JBoss DNA's current and planned behavior.
		</para> 
		<sect2>
			<title>L1 and L2 Features</title>
			<para>
				JBoss DNA currently supports most of the Level 1 and Level 2 feature set defined by the <ulink url="&JSR170;">JSR-170</ulink> specification.
				Queries, which are part of Level 1, are not implemented.  Some of the L2 features such as workspace cloning and updating, corresponding nodes, 
				and referential integrity for <code>REFERENCE</code> properties are also not yet implemented.  As the current implementation does provide many 
				of the features that may be needed by an application, we really hope that this release will allow you to give us some feedback on what we have so far.
			</para>
		</sect2>
		<sect2>
			<title>Optional Features</title>
			<para>
				JBoss DNA does not currently support any of the optional JCR features.  Currently, the observation optional feature is planned to be complete prior
				to the 1.0 release.  The locking optional feature <emphasis>may</emphasis> be implemented in this timeframe as well.  
				<note>
					<para>The JCR-SQL optional feature is not planned to be implemented as it has been dropped from the <ulink url="&JSR283;">JSR-283</ulink> specification.
					</para>
				</note>
			</para>
		</sect2>
		<sect2 id="dna_jcr_security">
			<title>JCR Security</title>
			<para>
				Although the <ulink url="&JSR170;">JSR-170</ulink> specification requires implementation of the <code>Session.checkPermission(String, String)</code> method,
				it allows implementors to choose the granularity of their access controls.  JBoss DNA supports coarse-grained, role-based access control at the repository 
				and workspace level.
			</para>
			<para>
				JBoss DNA currently defines two permissions: <code>READONLY</code> and <code>READWRITE</code>.  If the &Credentials; passed into <code>Session.login(...)</code>
				(or the &Subject; from the &AccessControlContext;, if one of the no-credential <code>login</code> methods were used) has either role, the session will have
				the corresponding access to all workspaces within the repository.  That is, having the <code>READONLY</code> role implies that <code>Session.checkPermission(path, "read")</code>
				will not throw an &AccessDeniedException;  for any value of <code>path</code> in any workspace in the repository.  Similarly, having the <code>READWRITE</code> 
				role implies that <code>Session.checkPermission(path, actions)</code> will not throw an &AccessDeniedException; for any values of <code>path</code> and 
				<code>actions</code>.
				  
				<note>
					<para> In this release, JBoss DNA does not properly check for actions or even check that the <code>actions</code> parameter passed into 
						<code>Session.checkPermission(...)</code> is even valid.  This will be corrected prior to the 1.0 release.
					</para>
				</note> 
				
				It is also possible to grant access only to one or more named workspaces.  For a workspace named "staging", this can be done by assigning a role named 
				<code>READONLY.staging</code>.  Appending <code>"." + workspaceName</code> to the <code>READWRITE</code> role works as well.
			</para>
			<para>
				As a final note, the JBoss DNA JCR implementation will likely have additional security roles added prior to the 1.0 release.  A <code>CONNECT</code> role
				is already being used by the DNA REST Server to control whether users have access to the repository through that means.   
			</para>
		</sect2>
		<sect2>
			<title>Built-In Node Types</title>
			<para>JBoss DNA supports all of the built-in node types described in the JSR-170 specification.  However, several of these node types
			(mix:lockable, mix:versionable, nt:version, nt:versionLabels, nt:versionHistory, and nt:frozenNode) are semantically meaningless
			as JBoss DNA does not yet support the locking or versioning optional features.
			</para>
			<para>Although JBoss DNA does define some custom node types in the <code>dna</code> namespace, none of these
			node types are intended to be used by developers integrating with JBoss DNA and may be changed or removed
			at any time.
			</para>
		</sect2>
		<sect2>
			<title>Custom Node Type Registration</title>
			<para>
				Although the <ulink url="&JSR170;">JSR-170</ulink> specification does not require support for registration of custom types, JBoss DNA supports this extremely
				useful feature.  Custom node types can be added at startup, as noted above or at runtime through a DNA-specific interface.  JBoss DNA supports defining node
				types either through a <ulink url="&JSR283;">JSR-283</ulink>-like template approach or through the use of &CND; (CND) files.
				Both type registration mechanisms are supported equally within JBoss DNA, although the CND approach for defining node types is recommended.
				<note>
					<para>JBoss DNA also supports defining custom node types to load at startup.  This is discussed in more detail
					in the next chapter.
					</para>
				</note>
			</para>
			<para>
				Although the JSR-283 specification is not yet final, it does provide a useful means of programatically defining JCR node types.  JBoss DNA supports a comparable
				node type definition API that implements the functionality from the specification, albeit with classes in an <code>org.jboss.dna.jcr</code> package.  The intent
				is to deprecate these classes and replace their usage with the JSR-283 equivalents after JBoss DNA fully supports in the JSR-283 specification in a future release.
				Node types can be defined like so:
	    <programlisting>
&Session; session = ... ;
NodeTypeManager nodeTypeManager = session.getWorkspace().getNodeTypeManager();

// Declare a mixin node type named "searchable" (with no namespace)
NodeTypeTemplate nodeType = nodeTypeManager.createNodeTypeTemplate();
nodeType.setName("searchable");
nodeType.setMixin(true);
nodeType.getNodeDefinitionTemplates().add(childNode);

// Add a mandatory child named "source" with a required primary type of "nt:file" 
NodeDefinitionTemplate childNode = nodeTypeManager.createNodeDefinitionTemplate();
childNode.setName("source");
childNode.setMandatory(true);
childNode.setRequiredPrimaryTypeNames(new String[] { "nt:file" });
childNode.setDefaultPrimaryType("nt:file");

// Add a multi-valued STRING property named "keywords"
PropertyDefinitionTemplate property = nodeTypeManager.createPropertyDefinitionTemplate();
property.setName("keywords");
property.setMultiple(true);
property.setRequiredType(PropertyType.STRING);
nodeType.getPropertyDefinitionTemplates().add(property);

// Register the custom node type
nodeTypeManager.registerNodeType(nodeType);
</programlisting>	
			Residual properties and child node definitions can also be defined simply by not calling <code>setName</code> on 
			the template.
			</para>
			<para>
			Custom node types can be defined more succinctly through the &CND; file format.  In fact, this is how JBoss
			DNA defines its built-in node types.  An example CND file that declares the same node type as above would be:
<programlisting>
[searchable] mixin
- keywords (string) multiple
+ source (nt:file) = nt:file
</programlisting>	
			This definition could then be registered with the following code snippet.
<programlisting>

String pathToCndFileInClassLoader = ...;
CndNodeTypeSource nodeTypeSource = new CndNodeTypeSource(pathToCndFileInClassLoader);

for (Problem problem : nodeTypeSource.getProblems()) {
    System.err.println(problem);
}
if (!nodeTypeSource.isValid()) {
    throw new IllegalStateException("Problems loading node types");
}

&Session; session = ... ;
NodeTypeManager nodeTypeManager = session.getWorkspace().getNodeTypeManager();
nodeTypeManager.registerNodeTypes(nodeTypeSource);
</programlisting>
				<note>
					<para> JBoss DNA does not yet support a simple means of unregistering types at this time, so be careful before registering types outside of a 
					sandboxed environment.
					</para>
				</note> 	

			</para>
		</sect2>
	</sect1>
	<sect1>
		<title>Summary</title>
		<para>
			In this chapter, we covered how to use JCR with JBoss DNA and learned about how it implements the JCR specification.  
			Now that you know how JBoss DNA repositories work and how to use JCR to work with DNA repositories, we'll move on in 
			the <link linkend="rest_service">next chapter</link> to show how you can use the RESTful web service to
			provide access to the content in a JCR repository to clients.
		</para>
	</sect1>
</chapter>
